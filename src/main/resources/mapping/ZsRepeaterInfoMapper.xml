<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yjjk.monitor.mapper.ZsRepeaterInfoMapper">
    <resultMap id="BaseResultMap" type="com.yjjk.monitor.entity.pojo.ZsRepeaterInfo">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="MAC" jdbcType="VARCHAR" property="mac"/>
        <result column="IP" jdbcType="VARCHAR" property="ip"/>
        <result column="linkStatus" jdbcType="INTEGER" property="linkStatus"/>
        <result column="machine_type_id" jdbcType="INTEGER" property="machineTypeId"/>
        <result column="department_id" jdbcType="INTEGER" property="departmentId"/>
        <result column="room_id" jdbcType="INTEGER" property="roomId"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="create_time" jdbcType="VARCHAR" property="createTime"/>
        <result column="fail_count" jdbcType="INTEGER" property="failCount"/>
    </resultMap>
    <sql id="Base_Column_List">
    id, MAC, IP, linkStatus, machine_type_id, department_id, room_id, remark, `status`, 
    create_time, fail_count
  </sql>

    <select id="selectRepeaters" parameterType="com.yjjk.monitor.entity.pojo.ZsRepeaterInfo"
            resultType="com.yjjk.monitor.entity.pojo.ZsRepeaterInfo">
        SELECT
        zri.id AS id,zri.MAC AS mac,zri.IP AS ip,zri.linkstatus AS linkstatus,zri.remark AS remark,zmti.`name` AS
        repeaterNum,zmti2.`name` AS repeaterName,zdi.`name` AS departmentName, zri2.`name` AS roomName,
        zdi.department_id,zri2.room_id
        FROM zs_repeater_info zri
        LEFT JOIN machine_type_info zmti ON zri.`machine_type_id` = zmti.`id`
        LEFT JOIN machine_type_info zmti2 ON zmti.`parent_id` = zmti2.`id`
        LEFT JOIN hospital_department zdi ON zri.`department_id` = zdi.`department_id`
        LEFT JOIN hospital_room zri2 ON zri2.`room_id` = zri.`room_id`
        <where>
            zri.status = 0
            <if test="id != null">
                and zri.id = #{id, jdbcType=INTEGER}
            </if>
            <if test="departmentId != null">
                and zri.department_id = #{departmentId, jdbcType=INTEGER}
            </if>
        </where>
        ORDER BY FIELD(zri.`department_id`,0) DESC, FIELD(zri.`room_id`,0) DESC, zri.`id`
        <if test="startLine != null and pageSize != null">
            limit #{startLine},#{pageSize}
        </if>
    </select>

    <select id="selectRepeaterCount" resultType="java.lang.Integer">
        select
        count(1)
        from zs_repeater_info
        <where>
            status = 0
            <if test="id != null">
                and id = #{id, jdbcType=INTEGER}
            </if>
            <if test="departmentId != null">
                and department_id = #{departmentId, jdbcType=INTEGER}
            </if>
        </where>
    </select>

    <select id="selectByBedId" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT zri.id
        FROM `zs_repeater_info` zri
                 LEFT JOIN hospital_bed zbi ON zbi.`room_id` = zri.`room_id`
        WHERE zbi.`bed_id` = #{bedId,jdbcType=INTEGER}
          and linkStatus = 0
    </select>

    <select id="hasRepeaterCount" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT count(*)
        FROM `zs_repeater_info` zri
                 LEFT JOIN hospital_bed zbi ON zbi.`room_id` = zri.`room_id`
        WHERE zbi.`bed_id` = #{bedId,jdbcType=INTEGER}
          and linkStatus = 0
    </select>

    <select id="isExistRepeater" resultType="java.lang.Integer"
            parameterType="com.yjjk.monitor.entity.pojo.ZsRepeaterInfo">
        select
        count(1)
        from zs_repeater_info
        <where>
            status = 0
            <if test="roomId != null">
                and room_id = #{roomId, jdbcType=INTEGER}
            </if>
        </where>
    </select>

    <select id="selectByMac" parameterType="java.lang.String" resultType="com.yjjk.monitor.entity.pojo.ZsRepeaterInfo">
        SELECT *
        FROM `zs_repeater_info`
        where mac = #{mac, jdbcType=INTEGER}
    </select>
    <select id="selectByIP" parameterType="java.lang.String" resultType="com.yjjk.monitor.entity.pojo.ZsRepeaterInfo">
        SELECT *
        FROM `zs_repeater_info`
        where IP = #{ip, jdbcType=INTEGER}
    </select>

    <update id="unbind" parameterType="java.util.Map">
        update zs_repeater_info
        <set>
            <if test="departmentId != null">
                department_id = 0,
                room_id = 0,
            </if>
            <if test="roomId != null">
                room_id = 0,
            </if>
        </set>
        <where>
            <if test="departmentId != null">
                and department_id = #{departmentId, jdbcType=INTEGER}
            </if>
            <if test="roomId != null">
                and room_id = #{roomId, jdbcType=INTEGER}
            </if>
        </where>
    </update>

    <select id="getRooms" parameterType="java.util.Map"
            resultType="com.yjjk.monitor.entity.VO.repeater.RoomsRepeaterVORooms">
        SELECT
        hr.room_id,
        hr.name as roomName
#         count(zri.id) as repeaterCount
        FROM hospital_department hd
        left join hospital_room hr on hr.department_id = hd.department_id
#         left join zs_repeater_info zri on zri.department_id = hd.department_id and hr.room_id = zri.room_id
        where hd.status = 0
        and hr.status = 0
#         and (zri.status = 0 OR zri.`id` IS NULL)
        <if test="departmentId != null">
            and hd.department_id = #{departmentId, jdbcType=INTEGER}
        </if>
        group by hr.room_id
    </select>
    <select id="getUnBindRepeaters" parameterType="java.util.Map"
            resultType="com.yjjk.monitor.entity.ListVO">
        SELECT zri.id,
               zri.IP as value
        FROM zs_repeater_info zri
        where zri.status = 0
          and (zri.department_id = 0
        <if test="departmentId != null">
            or (department_id = #{departmentId, jdbcType=INTEGER} and  zri.room_id = 0)
        </if>)
    </select>

    <update id="bindRepeater" parameterType="java.util.Map">
        update zs_repeater_info
        <set>
            <if test="departmentId != null">
                department_id = #{departmentId, jdbcType=INTEGER},
            </if>
            <if test="roomId != null">
                room_id = #{roomId, jdbcType=INTEGER},
            </if>
        </set>
        <where>
            <if test="id != null">
                and id = #{id, jdbcType=INTEGER}
            </if>
        </where>
    </update>
</mapper>